<script lang="ts" setup>
import { computed, reactive, ref } from 'vue'
import { Search } from '@element-plus/icons-vue'
import BaseList from '@/components/base-list.vue'
import EnumSelector from "@/components/enum/enum-selector.vue"
import EnumLabel from "@/components/enum/enum-label.vue"
import EnumStatusLabel from "@/components/enum/enum-status-label.vue"
import {{ class_name }}Edit from './edit.vue'
import EnumProvider from "@/components/enum/enum-provider.vue"

// API配置
const API = {
  list: '/{{ module_name }}.{{ class_name }}/list',
  delete: '/{{ module_name }}.{{ class_name }}/delete',
  {%- if has_delete %}
  restore: '/{{ module_name }}.{{ class_name }}/restore',
  restoreBatch: '/{{ module_name }}.{{ class_name }}/restoreBatch',
  {%- endif %}
}

const baseListRef = ref<InstanceType<typeof BaseList> | null>(null)

// 查询条件
const query = reactive({
  keywords: '',
  {%- for field in search_fields %}
  {%- if field.type == 'daterange' %}
  {{ field.start_field }}: '',
  {{ field.end_field }}: '',
  {%- elif field.type == 'numberrange' %}
  {{ field.start_field }}: null,
  {{ field.end_field }}: null,
  {%- else %}
  {{ field.field }}: null,
  {%- endif %}
  {%- endfor %}
  create_time_start: '',  // 添加创建时间范围
  create_time_end: '',
  {%- if has_delete %}
  is_trashed: false
  {%- endif %}
})

// 日期范围
const dateRange = ref<[string, string] | null>(null)
{%- if has_delete %}
    const showRestore = computed(() => query.is_trashed)
{%- endif %}

// 日期范围变化处理
const handleDateRangeChange = (val: [string, string] | null) => {
  if (val) {
    query.create_time_start = val[0]
    query.create_time_end = val[1]
  } else {
    query.create_time_start = ''
    query.create_time_end = ''
  }
}

{%- for field in search_fields %}
{%- if field.type == 'daterange' %}
const {{ field.model }} = ref<[string, string] | null>(null)
const handle{{ field.model|capitalize }}Change = (val: [string, string] | null) => {
  if (val) {
    query.{{ field.start_field }} = val[0]
    query.{{ field.end_field }} = val[1]
  } else {
    query.{{ field.start_field }} = ''
    query.{{ field.end_field }} = ''
  }
}
{%- endif %}
{%- endfor %}
</script>

<template>
  <enum-provider 
    url="/{{ module_name }}.Common/options" 
    :fields="[{% for field in enum_fields %}'{{ field.options_name }}'{{ ', ' if not loop.last }}{% endfor %}]"
  >
    <BaseList
      :api="API"
      title="{{ table_comment }}"
      :edit-component="{{ class_name }}Edit"
      :initial-query="query"
      ref="baseListRef"
    >
      <!-- 搜索表单项 -->
      <template #search-items>
        <!-- 关键字搜索 -->
        <el-form-item label="搜索" class="mt-[20px]">
          <el-input
            v-model="query.keywords"
            class="w-[420px]"
            placeholder="请输入关键字"
            :prefix-icon="Search"
          />
        </el-form-item>

        {%- for field in search_fields %}
        {%- if field.field != 'keywords' %}
        <!-- {{ field.label }} -->
        <el-form-item label="{{ field.label }}" class="mt-[20px]">
          {%- if field.type == 'enum' %}
          <enum-selector
            v-model="query.{{ field.field }}"
            field="{{ field.field|snake_to_camel }}Options"
            class="w-[{{ field.width|default(200) }}px]"
          />
          {%- elif field.type == 'daterange' %}
          <el-date-picker
            v-model="{{ field.model }}"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            value-format="YYYY-MM-DD"
            @change="handle{{ field.model|capitalize }}Change"
          />
          {%- elif field.type == 'numberrange' %}
          <div class="flex items-center gap-2">
            <el-input-number
              v-model="query.{{ field.start_field }}"
              class="!w-[120px]"
              placeholder="最小值"
              {%- if field.min is defined %}
              :min="{{ field.min }}"
              {%- endif %}
              clearable
            />
            <span>-</span>
            <el-input-number
              v-model="query.{{ field.end_field }}"
              class="!w-[120px]"
              placeholder="最大值"
              {%- if field.min is defined %}
              :min="{{ field.min }}"
              {%- endif %}
              clearable
            />
          </div>
          {%- else %}
          <el-input-number
            v-model="query.{{ field.field }}"
            class="!w-[{{ field.width|default(120) }}px]"
            placeholder="请输入{{ field.label }}"
            {%- if field.min is defined %}
            :min="{{ field.min }}"
            {%- endif %}
            clearable
          />
          {%- endif %}
        </el-form-item>
        {%- endif %}
        {%- endfor %}

        <!-- 创建时间范围 -->
        <el-form-item label="创建时间" class="mt-[20px]">
          <el-date-picker
            v-model="dateRange"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            value-format="YYYY-MM-DD"
            @change="handleDateRangeChange"
          />
        </el-form-item>
      </template>

      <!-- 表格列定义 -->
      {%- for field in table_fields %}
      <el-table-column prop="{{ field.field }}" label="{{ field.label }}"{%- if field.width %} width="{{ field.width }}"{%- endif %}{%- if field.align %} align="{{ field.align }}"{%- endif %}>{%- if field.type %}
        <template #default="{row}">
          {%- if field.type == 'enum' %}
          <enum-label field="{{ field.field|snake_to_camel }}Options" :value="row.{{ field.field }}"/>
          {%- elif field.type == 'datetime' %}
          {{ '{{ row.' + field.field + ' }}' }}
          {%- elif field.type == 'money' %}
          ¥{{ '{{ row.' + field.field + ' }}' }}
          {%- elif field.type == 'image' %}
          <el-image
            v-if="row.{{ field.field }}"
            :src="row.{{ field.field }}"
            :preview-src-list="[row.{{ field.field }}]"
            style="width: 80px; height: 60px"
            fit="cover"
          />
          {%- endif %}
        </template>
      {% endif -%}</el-table-column>
      {%- endfor %}

        {%- if has_delete %}
      <el-table-column prop="delete_time" label="删除时间" width="180" v-if="showRestore"/>
      {%- endif %}
    </BaseList>
  </enum-provider>
</template>